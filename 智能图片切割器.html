<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å›¾ç‰‡åˆ‡å‰²å™¨ - byé£æ‰¬ç­ç­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.2);
        }
        
        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .upload-area:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 15px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }
        
        .file-input {
            display: none;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        /* å·¦ä¾§å·¥ä½œåŒº */
        .workspace {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: linear-gradient(45deg, #f5f7fa 25%, transparent 25%), 
                        linear-gradient(-45deg, #f5f7fa 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f5f7fa 75%), 
                        linear-gradient(-45deg, transparent 75%, #f5f7fa 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        
        #previewCanvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            cursor: crosshair;
        }
        
        .grid-line {
            position: absolute;
            background-color: rgba(239, 68, 68, 0.7);
            z-index: 10;
            cursor: move;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .grid-line.vertical {
            width: 4px; /* ä»8pxæ”¹ä¸º4px */
            height: 100%;
            transform: translateX(-50%);
            cursor: ew-resize;
        }
        
        .grid-line.horizontal {
            height: 4px; /* ä»8pxæ”¹ä¸º4px */
            width: 100%;
            transform: translateY(-50%);
            cursor: ns-resize;
        }
        
        .grid-line:hover {
            background-color: rgba(239, 68, 68, 0.9);
            z-index: 20;
        }
        
        .grid-line.dragging {
            background-color: #3b82f6;
            z-index: 30;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #3b82f6;
        }
        
        .grid-line-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #3b82f6;
            font-weight: bold;
        }
        
        /* åˆ‡ç‰‡é¢„è§ˆåŒºåŸŸ */
        .slices-preview-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            margin-top: 20px;
            max-height: 500px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .preview-header h3 {
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .slices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            overflow-y: auto;
            flex: 1;
            padding: 5px;
        }
        
        .slice-card {
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 1;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
        }
        
        .slice-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }
        
        .slice-card.selected {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        .slice-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .slice-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        /* å³ä¾§æ§åˆ¶é¢æ¿ */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .section-header h3 {
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .badge {
            background: #3b82f6;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        /* é¢„è®¾å¼¹çª—æŒ‰é’® */
        .preset-button {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preset-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }
        
        .preset-icon {
            font-size: 1.2rem;
        }
        
        /* è¡Œé…ç½®åŒºåŸŸ */
        .rows-config-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
        }
        
        .row-config-item {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        .row-config-item:hover {
            border-color: #94a3b8;
        }
        
        .row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .row-title {
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .row-number {
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .row-controls {
            display: flex;
            gap: 8px;
        }
        
        .row-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            color: #64748b;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .row-btn:hover {
            background: #f1f5f9;
        }
        
        .row-btn.delete {
            color: #ef4444;
            border-color: #fecaca;
        }
        
        .row-btn.delete:hover {
            background: #fef2f2;
        }
        
        /* è¡Œå†…å®¹é…ç½® */
        .row-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .number-input {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            width: 100%;
        }
        
        .number-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* æ»‘å—æ§åˆ¶ */
        .slider-container {
            margin: 15px 0;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .slider-label {
            color: #475569;
            font-size: 0.9rem;
        }
        
        .slider-value {
            color: #3b82f6;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .custom-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }
        
        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid #3b82f6;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }
        
        .custom-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-outline {
            background: white;
            color: #475569;
            border: 2px solid #e2e8f0;
        }
        
        .btn-outline:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }
        
        .btn-icon {
            font-size: 1.2rem;
        }
        
        /* å·¥å…·æŒ‰é’®ç»„ */
        .tool-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tool-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: #64748b;
        }
        
        .tool-btn:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        
        .tool-icon {
            font-size: 18px;
        }
        
        /* ä¿¡æ¯é¢æ¿ */
        .info-panel {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .info-value {
            color: #1e293b;
            font-weight: 600;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        .loader-text {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #64748b;
        }
        
        /* æç¤ºæ¡† */
        .hint-box {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #475569;
        }
        
        .hint-title {
            color: #1e40af;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        /* é¢„è®¾å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: translateY(30px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        .modal-header {
            padding: 25px 25px 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: #1e293b;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #f1f5f9;
            color: #1e293b;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        /* é¢„è®¾ç½‘æ ¼ */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .preset-btn {
            padding: 20px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            color: #64748b;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .preset-btn:hover {
            border-color: #3b82f6;
            background: #f8fafc;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.1);
        }
        
        .preset-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .preset-icon {
            font-size: 28px;
            line-height: 1.2;
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .canvas-container {
                height: 350px;
            }
            
            .preset-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .row-content {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .slices-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .canvas-container {
                height: 300px;
            }
            
            .slices-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .tool-buttons {
                flex-wrap: wrap;
            }
            
            .row-controls {
                flex-wrap: wrap;
            }
            
            .preset-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ä¼˜åŒ–ç½‘æ ¼çº¿æ ‡ç­¾ */
        .line-label {
            position: absolute;
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .grid-line:hover .line-label {
            opacity: 1;
        }
        
        .grid-line.horizontal .line-label {
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .grid-line.vertical .line-label {
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
        }
        
        /* åˆ†å‰²çº¿æŒ‡ç¤ºå™¨ */
        .line-indicator {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border-radius: 50%;
            pointer-events: none;
            z-index: 5;
            display: none;
        }
        
        .line-indicator.active {
            display: block;
        }
        
        /* å½“å‰é€‰ä¸­åˆ‡ç‰‡ä¿¡æ¯ */
        .selected-slice-info {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #f59e0b;
        }
        
        .selected-slice-info h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .slice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
        }
        
        .slice-detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .slice-detail-label {
            color: #92400e;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .slice-detail-value {
            color: #78350f;
            font-weight: 600;
        }
        
        /* æ–°æ‰‹å¼•å¯¼æ ·å¼ */
        .tutorial-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tutorial-step {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 4px solid #3b82f6;
        }
        
        .step-number {
            background: #3b82f6;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content strong {
            display: block;
            color: #1e293b;
            margin-bottom: 5px;
            font-size: 1rem;
        }
        
        .step-content p {
            color: #64748b;
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.5;
        }
        
        /* å¸®åŠ©æŒ‰é’® */
        .help-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        /* åŒæŒ‰é’®å¸ƒå±€ */
        .dual-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .dual-buttons .btn {
            flex: 1;
            padding: 12px;
            font-size: 0.95rem;
        }
        
        /* é‡å‘½åæŒ‰é’®æ ·å¼ - æ”¹ä¸ºæ¼‚äº®çš„ç´«è‰²æ¸å˜ */
        .btn-rename {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
        }
        
        .btn-rename:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ™ºèƒ½å›¾ç‰‡åˆ‡å‰²å™¨ - byé£æ‰¬ç­ç­</h1>
        <p class="subtitle">è‡ªç”±è®¾ç½®æ¯è¡Œåˆ—æ•°ï¼Œè½»æ¾æ‹–æ‹½åˆ‡å‰²çº¿ï¼Œå®æ—¶é¢„è§ˆåˆ‡ç‰‡æ•ˆæœ</p>
    </div>
    
    <div class="app-container">
        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <h2 style="color: white; margin-bottom: 20px;">ä¸Šä¼ å›¾ç‰‡å¼€å§‹åˆ¶ä½œ</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <p style="font-size: 1.1rem; margin-bottom: 8px;">æ‹–æ”¾å›¾ç‰‡åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
                <p style="font-size: 0.9rem; opacity: 0.9;">æ”¯æŒ JPGã€PNGã€WebPï¼Œæœ€å¤§ 10MB</p>
                <input type="file" id="imageInput" class="file-input" accept="image/*">
            </div>
            <p id="fileName" style="margin-top: 15px; color: rgba(255,255,255,0.9);"></p>
        </div>
        
        <div class="main-content">
            <!-- å·¦ä¾§å·¥ä½œåŒº -->
            <div class="workspace">
                <div class="section-header">
                    <h3>å›¾ç‰‡åˆ‡å‰²ç¼–è¾‘åŒº</h3>
                    <div class="badge" id="sliceCountBadge">0 ä¸ªåˆ‡ç‰‡</div>
                </div>
                
                <div class="tool-buttons" id="toolButtons" style="display: none;">
                    <button class="tool-btn" id="addRowBtn" title="æ·»åŠ è¡Œ">
                        <span class="tool-icon">â•</span>
                        æ·»åŠ è¡Œ
                    </button>
                    <button class="tool-btn" id="uniformGridBtn" title="å‡åŒ€ç½‘æ ¼">
                        <span class="tool-icon">â¹ï¸</span>
                        å‡åŒ€ç½‘æ ¼
                    </button>
                    <button class="tool-btn" id="clearLinesBtn" title="æ¸…é™¤æ‰€æœ‰çº¿">
                        <span class="tool-icon">ğŸ—‘ï¸</span>
                        æ¸…é™¤æ‰€æœ‰çº¿
                    </button>
                    <button class="tool-btn" id="resetAllBtn" title="é‡ç½®æ‰€æœ‰">
                        <span class="tool-icon">ğŸ”„</span>
                        é‡ç½®æ‰€æœ‰
                    </button>
                </div>
                
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="previewCanvas"></canvas>
                    <!-- ç½‘æ ¼çº¿å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                    <div class="line-indicator" id="lineIndicator"></div>
                </div>
                
                <div class="info-panel" id="imageInfo" style="display: none;">
                    <div class="info-row">
                        <span class="info-label">å›¾ç‰‡å°ºå¯¸</span>
                        <span class="info-value" id="imageDimensions">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç½‘æ ¼å¸ƒå±€</span>
                        <span class="info-value" id="gridLayout">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">åˆ‡ç‰‡æ•°é‡</span>
                        <span class="info-value" id="sliceCount">0</span>
                    </div>
                </div>
                
                <!-- åˆ‡ç‰‡å®æ—¶é¢„è§ˆ -->
                <div class="slices-preview-section" id="slicesPreview" style="display: none;">
                    <div class="preview-header">
                        <h3>åˆ‡ç‰‡å®æ—¶é¢„è§ˆ</h3>
                        <div class="badge" id="previewCount">0</div>
                    </div>
                    
                    <div class="slices-grid" id="slicesGrid">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ–¼ï¸</div>
                            <p class="empty-text">è°ƒæ•´åˆ‡å‰²å¸ƒå±€åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºåˆ‡ç‰‡é¢„è§ˆ</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <!-- é¢„è®¾æ¨¡æ¿ -->
                <div class="panel-section">
                    <div class="section-header">
                        <h3>å¿«é€Ÿé¢„è®¾</h3>
                        <span class="badge">ä¸€é”®åº”ç”¨</span>
                    </div>
                    
                    <!-- é¢„è®¾å¼¹çª—æŒ‰é’® -->
                    <button class="preset-button" id="openPresetModalBtn">
                        <span class="btn-icon">ğŸ¨</span> é€‰æ‹©é¢„è®¾æ¨¡æ¿
                    </button>
                </div>
                
                <!-- è¡Œé…ç½® -->
                <div class="panel-section">
                    <div class="section-header">
                        <h3>è¡Œé…ç½®ï¼ˆæ”¯æŒå¼‚å½¢åˆ‡å‰²ï¼‰</h3>
                        <button class="row-btn" id="addRowConfigBtn">+ æ·»åŠ è¡Œ</button>
                    </div>
                    
                    <div class="rows-config-container" id="rowsConfigContainer">
                        <!-- è¡Œé…ç½®å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                        <div class="empty-state" style="padding: 20px 0;">
                            <div class="empty-icon">ğŸ“</div>
                            <p class="empty-text">ç‚¹å‡»"æ·»åŠ è¡Œ"å¼€å§‹é…ç½®å¼‚å½¢åˆ‡å‰²</p>
                        </div>
                    </div>
                </div>
                
                <!-- å½“å‰é€‰ä¸­åˆ‡ç‰‡ä¿¡æ¯ -->
                <div class="panel-section" id="selectedSlicePanel" style="display: none;">
                    <div class="section-header">
                        <h3>å½“å‰é€‰ä¸­åˆ‡ç‰‡</h3>
                    </div>
                    
                    <div id="selectedSliceInfo">
                        <div class="empty-state" style="padding: 10px 0;">
                            <div class="empty-icon">ğŸ¯</div>
                            <p class="empty-text">ç‚¹å‡»å·¦ä¾§åˆ‡ç‰‡é¢„è§ˆä¸­çš„åˆ‡ç‰‡è¿›è¡Œé€‰æ‹©</p>
                        </div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® - ç§»é™¤é‡ç½®æ‰€æœ‰è®¾ç½®æŒ‰é’® -->
                <div class="panel-section">
                    <div class="section-header">
                        <h3>å¯¼å‡ºåˆ‡ç‰‡</h3>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="downloadAllBtn">
                            <span class="btn-icon">ğŸ“¦</span> æ‰“åŒ…ä¸‹è½½å…¨éƒ¨
                        </button>
                    </div>
                    
                    <div class="hint-box">
                        <div class="hint-title">æ“ä½œæŒ‡å—</div>
                        <ul style="padding-left: 20px; margin: 0;">
                            <li><strong>æ‹–æ‹½åˆ†å‰²çº¿</strong>ï¼šç›´æ¥æ‹–åŠ¨çº¢è‰²çº¿æ¡è°ƒæ•´ä½ç½®</li>
                            <li><strong>åŒå‡»åˆ é™¤</strong>ï¼šåŒå‡»åˆ†å‰²çº¿å¯åˆ é™¤è¯¥çº¿</li>
                            <li><strong>å¼‚å½¢åˆ‡å‰²</strong>ï¼šä¸ºæ¯è¡Œè®¾ç½®ä¸åŒåˆ—æ•°</li>
                            <li><strong>é€‰ä¸­åˆ‡ç‰‡</strong>ï¼šç‚¹å‡»åˆ‡ç‰‡é¢„è§ˆä¸­çš„åˆ‡ç‰‡å¯é€‰ä¸­</li>
                            <li><strong>ä¸‹è½½åˆ‡ç‰‡</strong>ï¼šé€‰ä¸­åˆ‡ç‰‡åå¯åœ¨ä¸Šæ–¹é¢æ¿ä¸‹è½½</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¢„è®¾å¼¹çª— -->
    <div class="modal-overlay" id="presetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>é€‰æ‹©é¢„è®¾æ¨¡æ¿</h3>
                <button class="modal-close" id="closePresetModalBtn">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="preset-grid" id="presetGrid">
                    <button class="preset-btn" data-preset="3x3">
                        <span class="preset-icon">ğŸŸ¦ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦ğŸŸ¦</span>
                        ä¹å®«æ ¼ (3Ã—3)
                    </button>
                    <button class="preset-btn" data-preset="2x2">
                        <span class="preset-icon">ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦</span>
                        å››å®«æ ¼ (2Ã—2)
                    </button>
                    <button class="preset-btn" data-preset="3-4-3">
                        <span class="preset-icon">ğŸŸ¦ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦ğŸŸ¦</span>
                        ä¸Š3ä¸­4ä¸‹3
                    </button>
                    <button class="preset-btn" data-preset="1-2-3">
                        <span class="preset-icon">ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦ğŸŸ¦</span>
                        ä¸Š1ä¸­2ä¸‹3
                    </button>
                    <button class="preset-btn" data-preset="4x3">
                        <span class="preset-icon">ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦</span>
                        4Ã—3ç½‘æ ¼
                    </button>
                    <button class="preset-btn" data-preset="2-3-4">
                        <span class="preset-icon">ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦ğŸŸ¦<br>ğŸŸ¦ğŸŸ¦ğŸŸ¦ğŸŸ¦</span>
                        ä¸Š2ä¸­3ä¸‹4
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ–°æ‰‹å¼•å¯¼å¼¹çª— -->
    <div class="modal-overlay" id="tutorialModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ğŸ¯ æ–°æ‰‹å¼•å¯¼ - æ™ºèƒ½å›¾ç‰‡åˆ‡å‰²å™¨ä½¿ç”¨æŒ‡å—</h3>
                <button class="modal-close" id="closeTutorialModalBtn">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #3b82f6; margin-bottom: 15px;">å¿«é€Ÿå¼€å§‹æŒ‡å—</h4>
                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <strong>ä¸Šä¼ å›¾ç‰‡</strong>
                                <p>ç‚¹å‡»ä¸Šä¼ åŒºåŸŸæˆ–æ‹–æ”¾å›¾ç‰‡åˆ°æŒ‡å®šåŒºåŸŸï¼Œæ”¯æŒ JPGã€PNGã€WebP æ ¼å¼ï¼Œæœ€å¤§ 10MBã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <strong>é€‰æ‹©é¢„è®¾æ¨¡æ¿</strong>
                                <p>ä½¿ç”¨å³ä¾§"å¿«é€Ÿé¢„è®¾"é¢æ¿é€‰æ‹©é¢„è®¾æ¨¡æ¿ï¼Œæˆ–ä½¿ç”¨"è¡Œé…ç½®"è‡ªå®šä¹‰å¼‚å½¢åˆ‡å‰²ã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <strong>è°ƒæ•´åˆ‡å‰²çº¿</strong>
                                <p>æ‹–æ‹½çº¢è‰²åˆ†å‰²çº¿è°ƒæ•´ä½ç½®ï¼ŒåŒå‡»åˆ é™¤åˆ†å‰²çº¿ã€‚æ¯è¡Œå¯ä»¥è®¾ç½®ä¸åŒçš„åˆ—æ•°ã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <strong>é¢„è§ˆå’Œä¸‹è½½</strong>
                                <p>å·¦ä¾§é¢„è§ˆåŒºåŸŸå®æ—¶æ˜¾ç¤ºåˆ‡å‰²æ•ˆæœï¼Œé€‰ä¸­åˆ‡ç‰‡åå¯ä»¥å•ç‹¬ä¸‹è½½æˆ–é‡å‘½åä¸‹è½½ã€‚</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="hint-box" style="margin-top: 20px;">
                        <div class="hint-title">ğŸ’¡ é«˜çº§æŠ€å·§</div>
                        <ul style="padding-left: 20px; margin: 10px 0;">
                            <li><strong>å¼‚å½¢åˆ‡å‰²</strong>ï¼šæ¯è¡Œå¯ä»¥è®¾ç½®ä¸åŒçš„åˆ—æ•°ï¼Œå®ç°ä¸è§„åˆ™ç½‘æ ¼</li>
                            <li><strong>åˆ—å®½è°ƒæ•´</strong>ï¼šåœ¨è¡Œé…ç½®ä¸­æ‹–åŠ¨æ»‘å—å¯ä»¥è°ƒæ•´æ¯åˆ—çš„å®½åº¦æ¯”ä¾‹</li>
                            <li><strong>åˆ‡ç‰‡é‡å‘½å</strong>ï¼šé€‰ä¸­åˆ‡ç‰‡åå¯ä»¥è‡ªå®šä¹‰æ–‡ä»¶åå†ä¸‹è½½</li>
                            <li><strong>å¿«æ·é”®</strong>ï¼šESC å–æ¶ˆæ‹–æ‹½ï¼ŒåŒå‡»åˆ é™¤åˆ†å‰²çº¿</li>
                        </ul>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 5px; color: #64748b; font-size: 0.9rem;">
                        <input type="checkbox" id="dontShowAgain"> ä¸å†æ˜¾ç¤ºæ­¤å¼•å¯¼
                    </label>
                    <button class="btn btn-primary" id="startUsingBtn" style="margin-left: auto;">å¼€å§‹ä½¿ç”¨</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é‡å‘½åå¼¹çª— -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>âœï¸ é‡å‘½ååˆ‡ç‰‡</h3>
                <button class="modal-close" id="closeRenameModalBtn">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="control-group" style="margin-bottom: 20px;">
                    <label class="control-label" for="renameInput">æ–°æ–‡ä»¶å</label>
                    <input type="text" id="renameInput" class="number-input" placeholder="è¾“å…¥æ–‡ä»¶åï¼ˆæ— éœ€æ‰©å±•åï¼‰" style="padding: 12px;">
                    <p style="font-size: 0.85rem; color: #64748b; margin-top: 5px;">
                        å»ºè®®æ ¼å¼ï¼šåˆ‡ç‰‡_è¡Œ_åˆ— æˆ– è‡ªå®šä¹‰åç§°ã€‚ä¸‹è½½çš„æ–‡ä»¶å°†è‡ªåŠ¨æ·»åŠ  .png æ‰©å±•åã€‚
                    </p>
                </div>
                
                <div class="action-buttons" style="margin-top: 25px;">
                    <button class="btn btn-outline" id="cancelRenameBtn">å–æ¶ˆ</button>
                    <button class="btn btn-primary" id="confirmRenameBtn">ç¡®è®¤å¹¶ä¸‹è½½</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½é®ç½© -->
    <div class="loading" id="loading">
        <div class="loader"></div>
        <div class="loader-text">æ­£åœ¨å¤„ç†å›¾ç‰‡...</div>
    </div>

    <!-- å¸®åŠ©æŒ‰é’® -->
    <button class="help-button" id="helpButton" title="æ‰“å¼€æ–°æ‰‹å¼•å¯¼">?</button>

    <!-- å¼•å…¥JSZipåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- å¼•å…¥FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let originalImage = null;
        let canvas, ctx;
        let gridLines = [];
        let isDragging = false;
        let activeLine = null;
        let dragStartPos = { x: 0, y: 0 };
        let selectedSlice = null;
        let lineIndicator = null;
        
        // è¡Œé…ç½®æ•°æ®
        let rowsConfig = [];
        
        // DOMå…ƒç´ 
        const elements = {
            imageInput: document.getElementById('imageInput'),
            uploadArea: document.getElementById('uploadArea'),
            fileName: document.getElementById('fileName'),
            previewCanvas: document.getElementById('previewCanvas'),
            canvasContainer: document.getElementById('canvasContainer'),
            slicesGrid: document.getElementById('slicesGrid'),
            downloadAllBtn: document.getElementById('downloadAllBtn'),
            loading: document.getElementById('loading'),
            rowsConfigContainer: document.getElementById('rowsConfigContainer'),
            addRowConfigBtn: document.getElementById('addRowConfigBtn'),
            slicesPreview: document.getElementById('slicesPreview'),
            toolButtons: document.getElementById('toolButtons'),
            imageInfo: document.getElementById('imageInfo'),
            sliceCountBadge: document.getElementById('sliceCountBadge'),
            previewCount: document.getElementById('previewCount'),
            gridLayout: document.getElementById('gridLayout'),
            imageDimensions: document.getElementById('imageDimensions'),
            sliceCount: document.getElementById('sliceCount'),
            addRowBtn: document.getElementById('addRowBtn'),
            uniformGridBtn: document.getElementById('uniformGridBtn'),
            clearLinesBtn: document.getElementById('clearLinesBtn'),
            resetAllBtn: document.getElementById('resetAllBtn'),
            lineIndicator: document.getElementById('lineIndicator'),
            selectedSlicePanel: document.getElementById('selectedSlicePanel'),
            selectedSliceInfo: document.getElementById('selectedSliceInfo'),
            presetModal: document.getElementById('presetModal'),
            openPresetModalBtn: document.getElementById('openPresetModalBtn'),
            closePresetModalBtn: document.getElementById('closePresetModalBtn'),
            presetGrid: document.getElementById('presetGrid'),
            tutorialModal: document.getElementById('tutorialModal'),
            closeTutorialModalBtn: document.getElementById('closeTutorialModalBtn'),
            dontShowAgain: document.getElementById('dontShowAgain'),
            startUsingBtn: document.getElementById('startUsingBtn'),
            helpButton: document.getElementById('helpButton'),
            renameModal: document.getElementById('renameModal'),
            renameInput: document.getElementById('renameInput'),
            closeRenameModalBtn: document.getElementById('closeRenameModalBtn'),
            cancelRenameBtn: document.getElementById('cancelRenameBtn'),
            confirmRenameBtn: document.getElementById('confirmRenameBtn')
        };
        
        // å½“å‰è¦é‡å‘½åçš„åˆ‡ç‰‡
        let sliceToRename = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            canvas = elements.previewCanvas;
            ctx = canvas.getContext('2d');
            lineIndicator = elements.lineIndicator;
            
            setupEventListeners();
            setupPresetButtons();
            
            // åˆå§‹åŒ–é»˜è®¤é…ç½®ï¼ˆ3è¡Œï¼Œæ¯è¡Œ3åˆ—ï¼‰
            initializeDefaultConfig();
            updateRowsConfigUI();
            
            // åˆå§‹åŒ–æ–°æ‰‹å¼•å¯¼
            initTutorial();
        });
        
        // åˆå§‹åŒ–é»˜è®¤é…ç½®
        function initializeDefaultConfig() {
            rowsConfig = [
                { id: 1, cols: 3, heightPercent: 33.33, colWidths: [33.33, 33.33, 33.34] },
                { id: 2, cols: 3, heightPercent: 33.33, colWidths: [33.33, 33.33, 33.34] },
                { id: 3, cols: 3, heightPercent: 33.34, colWidths: [33.33, 33.33, 33.34] }
            ];
        }
        
        // åˆå§‹åŒ–æ–°æ‰‹å¼•å¯¼
        function initTutorial() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡å¼•å¯¼
            const hasShownTutorial = localStorage.getItem('hasShownTutorial');
            
            // å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œä¸è‡ªåŠ¨æ˜¾ç¤ºå¼•å¯¼
            // å¯ä»¥é€šè¿‡å¸®åŠ©æŒ‰é’®æ‰‹åŠ¨æ‰“å¼€
            if (!hasShownTutorial) {
                // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
                setTimeout(() => {
                    openTutorialModal();
                }, 1000);
            }
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬
            setupTutorialEvents();
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ä¸Šä¼ åŒºåŸŸ
            elements.uploadArea.addEventListener('click', () => elements.imageInput.click());
            
            elements.uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.uploadArea.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
            });
            
            elements.uploadArea.addEventListener('dragleave', () => {
                elements.uploadArea.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            });
            
            elements.uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.uploadArea.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                
                if (e.dataTransfer.files.length) {
                    elements.imageInput.files = e.dataTransfer.files;
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            elements.imageInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            // é¢„è®¾å¼¹çª—æŒ‰é’®
            elements.openPresetModalBtn.addEventListener('click', openPresetModal);
            elements.closePresetModalBtn.addEventListener('click', closePresetModal);
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­å¼¹çª—
            elements.presetModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closePresetModal();
                }
            });
            
            // ESCé”®å…³é—­å¼¹çª—
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && elements.presetModal.style.display !== 'none') {
                    closePresetModal();
                }
            });
            
            // æ·»åŠ è¡Œé…ç½®æŒ‰é’® - ä¿®å¤è¿™é‡Œï¼Œæ·»åŠ è¡Œåé‡æ–°ç»˜åˆ¶ç½‘æ ¼
            elements.addRowConfigBtn.addEventListener('click', function() {
                addRowConfig();
                // æ·»åŠ è¡Œåé‡æ–°ç»˜åˆ¶ç½‘æ ¼å’Œæ›´æ–°é¢„è§ˆ
                if (originalImage) {
                    createGridLines();
                    drawImageWithGrid();
                    updateSlicesPreview();
                }
            });
            
            // å·¥å…·æŒ‰é’®
            elements.addRowBtn.addEventListener('click', function() {
                addRowConfig();
                // æ·»åŠ è¡Œåé‡æ–°ç»˜åˆ¶ç½‘æ ¼å’Œæ›´æ–°é¢„è§ˆ
                if (originalImage) {
                    createGridLines();
                    drawImageWithGrid();
                    updateSlicesPreview();
                }
            });
            
            elements.uniformGridBtn.addEventListener('click', applyUniformGrid);
            elements.clearLinesBtn.addEventListener('click', clearAllLines);
            elements.resetAllBtn.addEventListener('click', resetAll);
            
            // æ“ä½œæŒ‰é’® - ç§»é™¤é‡ç½®æŒ‰é’®
            elements.downloadAllBtn.addEventListener('click', downloadAllSlices);
            
            // é¼ æ ‡äº‹ä»¶ - ç®€åŒ–æ‹–æ‹½é€»è¾‘
            document.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
            
            // è§¦æ‘¸äº‹ä»¶
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', handleKeyboard);
        }
        
        // è®¾ç½®æ–°æ‰‹å¼•å¯¼äº‹ä»¶
        function setupTutorialEvents() {
            // å¸®åŠ©æŒ‰é’®
            elements.helpButton.addEventListener('click', openTutorialModal);
            
            // å…³é—­å¼•å¯¼æŒ‰é’®
            elements.closeTutorialModalBtn.addEventListener('click', closeTutorialModal);
            elements.startUsingBtn.addEventListener('click', closeTutorialModal);
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            elements.tutorialModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTutorialModal();
                }
            });
            
            // ESCé”®å…³é—­å¼•å¯¼
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && elements.tutorialModal.style.display !== 'none') {
                    closeTutorialModal();
                }
            });
            
            // é‡å‘½åç›¸å…³äº‹ä»¶
            elements.closeRenameModalBtn.addEventListener('click', closeRenameModal);
            elements.cancelRenameBtn.addEventListener('click', closeRenameModal);
            elements.confirmRenameBtn.addEventListener('click', confirmRenameAndDownload);
            
            // ç‚¹å‡»é‡å‘½åå¼¹çª—å¤–éƒ¨å…³é—­
            elements.renameModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeRenameModal();
                }
            });
            
            // ESCé”®å…³é—­é‡å‘½åå¼¹çª—
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && elements.renameModal.style.display !== 'none') {
                    closeRenameModal();
                }
            });
        }
        
        // æ‰“å¼€æ–°æ‰‹å¼•å¯¼
        function openTutorialModal() {
            elements.tutorialModal.style.display = 'flex';
            setTimeout(() => {
                elements.tutorialModal.classList.add('active');
            }, 10);
        }
        
        // å…³é—­æ–°æ‰‹å¼•å¯¼
        function closeTutorialModal() {
            // æ£€æŸ¥"ä¸å†æ˜¾ç¤º"å¤é€‰æ¡†
            if (elements.dontShowAgain.checked) {
                localStorage.setItem('hasShownTutorial', 'true');
            }
            
            elements.tutorialModal.classList.remove('active');
            setTimeout(() => {
                elements.tutorialModal.style.display = 'none';
            }, 300);
        }
        
        // æ‰“å¼€é‡å‘½åå¼¹çª—
        function openRenameModal(slice) {
            sliceToRename = slice;
            
            // è®¾ç½®é»˜è®¤æ–‡ä»¶å
            const defaultName = `åˆ‡ç‰‡_${slice.row}_${slice.col}`;
            elements.renameInput.value = defaultName;
            
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                elements.renameInput.focus();
                elements.renameInput.select();
            }, 100);
            
            elements.renameModal.style.display = 'flex';
            setTimeout(() => {
                elements.renameModal.classList.add('active');
            }, 10);
        }
        
        // å…³é—­é‡å‘½åå¼¹çª—
        function closeRenameModal() {
            sliceToRename = null;
            elements.renameModal.classList.remove('active');
            setTimeout(() => {
                elements.renameModal.style.display = 'none';
            }, 300);
        }
        
        // ç¡®è®¤é‡å‘½åå¹¶ä¸‹è½½
        function confirmRenameAndDownload() {
            if (!sliceToRename) return;
            
            const newName = elements.renameInput.value.trim();
            if (!newName) {
                alert('è¯·è¾“å…¥æ–‡ä»¶åï¼');
                elements.renameInput.focus();
                return;
            }
            
            // ä¸‹è½½é‡å‘½ååçš„åˆ‡ç‰‡
            downloadRenamedSlice(newName);
            closeRenameModal();
        }
        
        // ä¸‹è½½é‡å‘½ååçš„åˆ‡ç‰‡
        function downloadRenamedSlice(fileName) {
            if (!sliceToRename) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = sliceToRename.width;
            canvas.height = sliceToRename.height;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(
                originalImage,
                sliceToRename.sx, sliceToRename.sy, sliceToRename.swidth, sliceToRename.sheight,
                0, 0, sliceToRename.width, sliceToRename.height
            );
            
            canvas.toBlob(blob => {
                // ç¡®ä¿æ–‡ä»¶åæœ‰.pngæ‰©å±•å
                const finalFileName = fileName.endsWith('.png') ? fileName : `${fileName}.png`;
                saveAs(blob, finalFileName);
            }, 'image/png', 0.95);
        }
        
        // æ‰“å¼€é¢„è®¾å¼¹çª—
        function openPresetModal() {
            elements.presetModal.style.display = 'flex';
            // ä½¿ç”¨setTimeoutè§¦å‘CSSåŠ¨ç”»
            setTimeout(() => {
                elements.presetModal.classList.add('active');
            }, 10);
        }
        
        // å…³é—­é¢„è®¾å¼¹çª—
        function closePresetModal() {
            elements.presetModal.classList.remove('active');
            setTimeout(() => {
                elements.presetModal.style.display = 'none';
            }, 300);
        }
        
        // è®¾ç½®é¢„è®¾æŒ‰é’®
        function setupPresetButtons() {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    
                    // è®¾ç½®æ¿€æ´»çŠ¶æ€
                    this.classList.add('active');
                    
                    // åº”ç”¨é¢„è®¾
                    const preset = this.dataset.preset;
                    applyPreset(preset);
                    
                    // å…³é—­å¼¹çª—
                    setTimeout(() => {
                        closePresetModal();
                    }, 500);
                });
            });
        }
        
        // åº”ç”¨é¢„è®¾
        function applyPreset(preset) {
            switch(preset) {
                case '3x3': // ä¹å®«æ ¼
                    rowsConfig = [
                        { id: 1, cols: 3, heightPercent: 33.33, colWidths: [33.33, 33.33, 33.34] },
                        { id: 2, cols: 3, heightPercent: 33.33, colWidths: [33.33, 33.33, 33.34] },
                        { id: 3, cols: 3, heightPercent: 33.34, colWidths: [33.33, 33.33, 33.34] }
                    ];
                    break;
                    
                case '2x2': // å››å®«æ ¼
                    rowsConfig = [
                        { id: 1, cols: 2, heightPercent: 50, colWidths: [50, 50] },
                        { id: 2, cols: 2, heightPercent: 50, colWidths: [50, 50] }
                    ];
                    break;
                    
                case '3-4-3': // ä¸Š3ä¸­4ä¸‹3
                    rowsConfig = [
                        { id: 1, cols: 3, heightPercent: 30, colWidths: [33.33, 33.33, 33.34] },
                        { id: 2, cols: 4, heightPercent: 40, colWidths: [25, 25, 25, 25] },
                        { id: 3, cols: 3, heightPercent: 30, colWidths: [33.33, 33.33, 33.34] }
                    ];
                    break;
                    
                case '1-2-3': // ä¸Š1ä¸­2ä¸‹3
                    rowsConfig = [
                        { id: 1, cols: 1, heightPercent: 25, colWidths: [100] },
                        { id: 2, cols: 2, heightPercent: 35, colWidths: [50, 50] },
                        { id: 3, cols: 3, heightPercent: 40, colWidths: [33.33, 33.33, 33.34] }
                    ];
                    break;
                    
                case '4x3': // 4Ã—3ç½‘æ ¼
                    rowsConfig = [
                        { id: 1, cols: 4, heightPercent: 33.33, colWidths: [25, 25, 25, 25] },
                        { id: 2, cols: 4, heightPercent: 33.33, colWidths: [25, 25, 25, 25] },
                        { id: 3, cols: 4, heightPercent: 33.34, colWidths: [25, 25, 25, 25] }
                    ];
                    break;
                    
                case '2-3-4': // ä¸Š2ä¸­3ä¸‹4
                    rowsConfig = [
                        { id: 1, cols: 2, heightPercent: 25, colWidths: [50, 50] },
                        { id: 2, cols: 3, heightPercent: 35, colWidths: [33.33, 33.33, 33.34] },
                        { id: 3, cols: 4, heightPercent: 40, colWidths: [25, 25, 25, 25] }
                    ];
                    break;
            }
            
            updateRowsConfigUI();
            
            if (originalImage) {
                createGridLines();
                drawImageWithGrid();
                updateSlicesPreview();
            }
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(file) {
            if (!file.type.match('image.*')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MBï¼');
                return;
            }
            
            elements.fileName.textContent = `ğŸ“¸ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                originalImage = new Image();
                originalImage.onload = function() {
                    setupCanvas();
                    updateImageInfo();
                    showUIElements();
                    createGridLines();
                    drawImageWithGrid();
                    updateSlicesPreview();
                };
                originalImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // è®¾ç½®ç”»å¸ƒ
        function setupCanvas() {
            const container = elements.canvasContainer;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            const imgAspect = originalImage.width / originalImage.height;
            const containerAspect = containerWidth / containerHeight;
            
            let canvasWidth, canvasHeight;
            
            if (imgAspect > containerAspect) {
                canvasWidth = containerWidth;
                canvasHeight = containerWidth / imgAspect;
            } else {
                canvasHeight = containerHeight;
                canvasWidth = containerHeight * imgAspect;
            }
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // æ›´æ–°å®¹å™¨å¤§å°ä»¥åŒ¹é…canvas
            canvas.style.width = `${canvasWidth}px`;
            canvas.style.height = `${canvasHeight}px`;
        }
        
        // æ˜¾ç¤ºUIå…ƒç´ 
        function showUIElements() {
            elements.toolButtons.style.display = 'flex';
            elements.slicesPreview.style.display = 'flex';
            elements.imageInfo.style.display = 'block';
            elements.selectedSlicePanel.style.display = 'block';
        }
        
        // æ›´æ–°å›¾ç‰‡ä¿¡æ¯
        function updateImageInfo() {
            elements.imageDimensions.textContent = `${originalImage.width} Ã— ${originalImage.height} åƒç´ `;
            updateGridInfo();
        }
        
        // æ›´æ–°ç½‘æ ¼ä¿¡æ¯
        function updateGridInfo() {
            const totalSlices = rowsConfig.reduce((sum, row) => sum + row.cols, 0);
            const rowInfo = rowsConfig.map(row => row.cols).join('-');
            
            elements.gridLayout.textContent = `${rowsConfig.length}è¡Œ (${rowInfo}åˆ—)`;
            elements.sliceCount.textContent = totalSlices;
            elements.sliceCountBadge.textContent = `${totalSlices} ä¸ªåˆ‡ç‰‡`;
            elements.previewCount.textContent = totalSlices;
        }
        
        // æ·»åŠ è¡Œé…ç½® - ä¿®å¤ï¼šå¹³å‡åˆ†é…è¡Œé«˜
        function addRowConfig() {
            const newRowId = rowsConfig.length > 0 ? Math.max(...rowsConfig.map(r => r.id)) + 1 : 1;
            const defaultCols = 3;
            const totalRows = rowsConfig.length + 1;
            
            // è®¡ç®—å¹³å‡é«˜åº¦
            const averageHeight = 100 / totalRows;
            
            // é‡ç½®æ‰€æœ‰è¡Œçš„é«˜åº¦ä¸ºå¹³å‡å€¼
            rowsConfig.forEach(row => {
                row.heightPercent = averageHeight;
            });
            
            // æ·»åŠ æ–°è¡Œ
            rowsConfig.push({
                id: newRowId,
                cols: defaultCols,
                heightPercent: averageHeight,
                colWidths: Array(defaultCols).fill(100 / defaultCols)
            });
            
            updateRowsConfigUI();
        }
        
        // æ›´æ–°è¡Œé…ç½®UI
        function updateRowsConfigUI() {
            elements.rowsConfigContainer.innerHTML = '';
            
            if (rowsConfig.length === 0) {
                elements.rowsConfigContainer.innerHTML = `
                    <div class="empty-state" style="padding: 20px 0;">
                        <div class="empty-icon">ğŸ“</div>
                        <p class="empty-text">ç‚¹å‡»"æ·»åŠ è¡Œ"å¼€å§‹é…ç½®å¼‚å½¢åˆ‡å‰²</p>
                    </div>
                `;
                return;
            }
            
            rowsConfig.forEach((row, index) => {
                const rowItem = document.createElement('div');
                rowItem.className = 'row-config-item';
                rowItem.dataset.index = index;
                
                // è¡Œå¤´éƒ¨
                const rowHeader = document.createElement('div');
                rowHeader.className = 'row-header';
                
                const rowTitle = document.createElement('div');
                rowTitle.className = 'row-title';
                rowTitle.innerHTML = `
                    <span class="row-number">${index + 1}</span>
                    <span>ç¬¬ ${index + 1} è¡Œ</span>
                `;
                
                const rowControls = document.createElement('div');
                rowControls.className = 'row-controls';
                
                // ä¸Šç§»æŒ‰é’®
                if (index > 0) {
                    const moveUpBtn = document.createElement('button');
                    moveUpBtn.className = 'row-btn';
                    moveUpBtn.innerHTML = 'â†‘ ä¸Šç§»';
                    moveUpBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        moveRow(index, 'up');
                    });
                    rowControls.appendChild(moveUpBtn);
                }
                
                // ä¸‹ç§»æŒ‰é’®
                if (index < rowsConfig.length - 1) {
                    const moveDownBtn = document.createElement('button');
                    moveDownBtn.className = 'row-btn';
                    moveDownBtn.innerHTML = 'â†“ ä¸‹ç§»';
                    moveDownBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        moveRow(index, 'down');
                    });
                    rowControls.appendChild(moveDownBtn);
                }
                
                // åˆ é™¤æŒ‰é’®
                if (rowsConfig.length > 1) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'row-btn delete';
                    deleteBtn.innerHTML = 'ğŸ—‘ï¸ åˆ é™¤';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteRow(index);
                    });
                    rowControls.appendChild(deleteBtn);
                }
                
                rowHeader.appendChild(rowTitle);
                rowHeader.appendChild(rowControls);
                rowItem.appendChild(rowHeader);
                
                // è¡Œå†…å®¹
                const rowContent = document.createElement('div');
                rowContent.className = 'row-content';
                
                // åˆ—æ•°è®¾ç½®
                const colsGroup = document.createElement('div');
                colsGroup.className = 'control-group';
                
                const colsLabel = document.createElement('label');
                colsLabel.className = 'control-label';
                colsLabel.textContent = 'åˆ—æ•°';
                colsLabel.htmlFor = `row-${index}-cols`;
                
                const colsInput = document.createElement('input');
                colsInput.type = 'number';
                colsInput.id = `row-${index}-cols`;
                colsInput.className = 'number-input';
                colsInput.min = 1;
                colsInput.max = 10;
                colsInput.value = row.cols;
                colsInput.dataset.index = index;
                colsInput.dataset.type = 'cols';
                
                colsInput.addEventListener('change', function() {
                    const rowIndex = parseInt(this.dataset.index);
                    const newCols = parseInt(this.value);
                    
                    if (newCols < 1 || newCols > 10) {
                        alert('åˆ—æ•°å¿…é¡»åœ¨1-10ä¹‹é—´');
                        this.value = rowsConfig[rowIndex].cols;
                        return;
                    }
                    
                    rowsConfig[rowIndex].cols = newCols;
                    // é‡æ–°è®¡ç®—åˆ—å®½ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰
                    rowsConfig[rowIndex].colWidths = Array(newCols).fill(100 / newCols);
                    
                    updateRowsConfigUI();
                    if (originalImage) {
                        createGridLines();
                        drawImageWithGrid();
                        updateSlicesPreview();
                    }
                });
                
                colsGroup.appendChild(colsLabel);
                colsGroup.appendChild(colsInput);
                rowContent.appendChild(colsGroup);
                
                // è¡Œé«˜è®¾ç½®
                const heightGroup = document.createElement('div');
                heightGroup.className = 'control-group';
                
                const heightLabel = document.createElement('label');
                heightLabel.className = 'control-label';
                heightLabel.textContent = 'è¡Œé«˜ (%)';
                heightLabel.htmlFor = `row-${index}-height`;
                
                const heightInput = document.createElement('input');
                heightInput.type = 'number';
                heightInput.id = `row-${index}-height`;
                heightInput.className = 'number-input';
                heightInput.min = 5;
                heightInput.max = 95;
                heightInput.step = 1;
                heightInput.value = Math.round(row.heightPercent);
                heightInput.dataset.index = index;
                heightInput.dataset.type = 'height';
                
                heightInput.addEventListener('change', function() {
                    const rowIndex = parseInt(this.dataset.index);
                    const newHeight = parseInt(this.value);
                    
                    if (newHeight < 5 || newHeight > 95) {
                        alert('è¡Œé«˜å¿…é¡»åœ¨5%-95%ä¹‹é—´');
                        this.value = Math.round(rowsConfig[rowIndex].heightPercent);
                        return;
                    }
                    
                    rowsConfig[rowIndex].heightPercent = newHeight;
                    
                    // è°ƒæ•´å…¶ä»–è¡Œçš„é«˜åº¦ï¼Œä½¿æ€»å’Œä¸º100%
                    adjustRowHeights(rowIndex);
                    
                    updateRowsConfigUI();
                    if (originalImage) {
                        createGridLines();
                        drawImageWithGrid();
                        updateSlicesPreview();
                    }
                });
                
                heightGroup.appendChild(heightLabel);
                heightGroup.appendChild(heightInput);
                rowContent.appendChild(heightGroup);
                
                rowItem.appendChild(rowContent);
                
                // åˆ—å®½æ»‘å—ï¼ˆå½“åˆ—æ•°>1æ—¶æ˜¾ç¤ºï¼‰
                if (row.cols > 1) {
                    const colWidthsContainer = document.createElement('div');
                    colWidthsContainer.style.gridColumn = '1 / -1';
                    colWidthsContainer.style.marginTop = '10px';
                    
                    const colWidthsLabel = document.createElement('div');
                    colWidthsLabel.className = 'control-label';
                    colWidthsLabel.textContent = 'åˆ—å®½è°ƒæ•´';
                    colWidthsContainer.appendChild(colWidthsLabel);
                    
                    // ä¸ºæ¯åˆ—åˆ›å»ºä¸€ä¸ªæ»‘å—
                    for (let col = 0; col < row.cols - 1; col++) {
                        const sliderContainer = document.createElement('div');
                        sliderContainer.className = 'slider-container';
                        
                        const sliderHeader = document.createElement('div');
                        sliderHeader.className = 'slider-header';
                        
                        const sliderLabel = document.createElement('span');
                        sliderLabel.className = 'slider-label';
                        sliderLabel.textContent = `åˆ— ${col + 1} å’Œ ${col + 2}`;
                        
                        const sliderValue = document.createElement('span');
                        sliderValue.className = 'slider-value';
                        const currentPosition = row.colWidths.slice(0, col + 1).reduce((a, b) => a + b, 0);
                        sliderValue.textContent = `${Math.round(currentPosition)}%`;
                        
                        sliderHeader.appendChild(sliderLabel);
                        sliderHeader.appendChild(sliderValue);
                        
                        const slider = document.createElement('input');
                        slider.type = 'range';
                        slider.className = 'custom-slider';
                        slider.min = 1;
                        slider.max = 99;
                        slider.step = 1;
                        slider.value = Math.round(currentPosition);
                        slider.dataset.rowIndex = index;
                        slider.dataset.colIndex = col;
                        
                        slider.addEventListener('input', function() {
                            const rowIndex = parseInt(this.dataset.rowIndex);
                            const colIndex = parseInt(this.dataset.colIndex);
                            const value = parseInt(this.value);
                            
                            // æ›´æ–°åˆ—å®½
                            updateColumnWidths(rowIndex, colIndex, value);
                            
                            sliderValue.textContent = `${value}%`;
                            
                            if (originalImage) {
                                createGridLines();
                                drawImageWithGrid();
                                updateSlicesPreview();
                            }
                        });
                        
                        sliderContainer.appendChild(sliderHeader);
                        sliderContainer.appendChild(slider);
                        colWidthsContainer.appendChild(sliderContainer);
                    }
                    
                    rowItem.appendChild(colWidthsContainer);
                }
                
                elements.rowsConfigContainer.appendChild(rowItem);
            });
            
            updateGridInfo();
        }
        
        // ç§»åŠ¨è¡Œ
        function moveRow(index, direction) {
            if (direction === 'up' && index > 0) {
                [rowsConfig[index], rowsConfig[index - 1]] = [rowsConfig[index - 1], rowsConfig[index]];
            } else if (direction === 'down' && index < rowsConfig.length - 1) {
                [rowsConfig[index], rowsConfig[index + 1]] = [rowsConfig[index + 1], rowsConfig[index]];
            }
            
            updateRowsConfigUI();
            
            if (originalImage) {
                createGridLines();
                drawImageWithGrid();
                updateSlicesPreview();
            }
        }
        
        // åˆ é™¤è¡Œ - ä¿®å¤ï¼šåˆ é™¤åé‡æ–°å¹³å‡åˆ†é…é«˜åº¦
        function deleteRow(index) {
            if (rowsConfig.length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€è¡Œï¼');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€è¡Œå—ï¼Ÿ')) return;
            
            rowsConfig.splice(index, 1);
            
            // é‡æ–°å¹³å‡åˆ†é…é«˜åº¦
            const averageHeight = 100 / rowsConfig.length;
            rowsConfig.forEach(row => {
                row.heightPercent = averageHeight;
            });
            
            updateRowsConfigUI();
            
            if (originalImage) {
                createGridLines();
                drawImageWithGrid();
                updateSlicesPreview();
            }
        }
        
        // è°ƒæ•´è¡Œé«˜åº¦ï¼Œä½¿æ€»å’Œä¸º100%
        function adjustRowHeights(changedIndex) {
            const totalHeight = rowsConfig.reduce((sum, row) => sum + row.heightPercent, 0);
            
            if (totalHeight !== 100) {
                const diff = totalHeight - 100;
                const remainingRows = rowsConfig.filter((_, i) => i !== changedIndex);
                
                if (remainingRows.length > 0) {
                    const adjustPerRow = diff / remainingRows.length;
                    
                    rowsConfig.forEach((row, i) => {
                        if (i !== changedIndex) {
                            row.heightPercent -= adjustPerRow;
                            // ç¡®ä¿é«˜åº¦åœ¨åˆç†èŒƒå›´å†…
                            row.heightPercent = Math.max(5, Math.min(95, row.heightPercent));
                        }
                    });
                    
                    // é€’å½’è°ƒæ•´ç›´åˆ°æ€»å’Œä¸º100%
                    adjustRowHeights(changedIndex);
                }
            }
        }
        
        // æ›´æ–°åˆ—å®½
        function updateColumnWidths(rowIndex, colIndex, positionPercent) {
            const row = rowsConfig[rowIndex];
            
            // è®¡ç®—å½“å‰ç´¯è®¡å®½åº¦
            let currentCumulative = 0;
            for (let i = 0; i <= colIndex; i++) {
                currentCumulative += row.colWidths[i];
            }
            
            // è®¡ç®—å·®å¼‚
            const diff = positionPercent - currentCumulative;
            
            if (diff !== 0) {
                // è°ƒæ•´ç›¸å…³åˆ—çš„å®½åº¦
                row.colWidths[colIndex] += diff;
                row.colWidths[colIndex + 1] -= diff;
                
                // ç¡®ä¿å®½åº¦åœ¨åˆç†èŒƒå›´å†…ï¼ˆæ¯åˆ—è‡³å°‘5%ï¼‰
                if (row.colWidths[colIndex] < 5) {
                    const adjust = 5 - row.colWidths[colIndex];
                    row.colWidths[colIndex] = 5;
                    row.colWidths[colIndex + 1] -= adjust;
                }
                if (row.colWidths[colIndex + 1] < 5) {
                    const adjust = 5 - row.colWidths[colIndex + 1];
                    row.colWidths[colIndex + 1] = 5;
                    row.colWidths[colIndex] -= adjust;
                }
            }
        }
        
        // åˆ›å»ºç½‘æ ¼çº¿
        function createGridLines() {
            // ç§»é™¤æ—§ç½‘æ ¼çº¿
            gridLines.forEach(line => {
                if (line.element && line.element.parentNode) {
                    line.element.parentNode.removeChild(line.element);
                }
            });
            gridLines = [];
            
            if (!originalImage || rowsConfig.length === 0) return;
            
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = elements.canvasContainer.getBoundingClientRect();
            
            // åˆ›å»ºæ°´å¹³ç½‘æ ¼çº¿ï¼ˆè¡Œé—´åˆ†å‰²çº¿ï¼‰
            let cumulativeHeight = 0;
            for (let i = 0; i < rowsConfig.length - 1; i++) {
                cumulativeHeight += rowsConfig[i].heightPercent;
                
                const line = createLineElement('horizontal', cumulativeHeight, i, 'row');
                gridLines.push({
                    element: line,
                    type: 'row',
                    index: i,
                    position: cumulativeHeight
                });
            }
            
            // åˆ›å»ºæ¯è¡Œçš„å‚ç›´ç½‘æ ¼çº¿
            rowsConfig.forEach((row, rowIndex) => {
                let cumulativeWidth = 0;
                
                for (let col = 0; col < row.cols - 1; col++) {
                    cumulativeWidth += row.colWidths[col];
                    
                    const line = createLineElement('vertical', cumulativeWidth, rowIndex, 'col', col);
                    gridLines.push({
                        element: line,
                        type: 'col',
                        rowIndex: rowIndex,
                        colIndex: col,
                        position: cumulativeWidth
                    });
                }
            });
        }
        
        // åˆ›å»ºç½‘æ ¼çº¿å…ƒç´ 
        function createLineElement(type, positionPercent, index, lineType, colIndex = null) {
            const line = document.createElement('div');
            line.className = `grid-line ${type}`;
            line.dataset.type = lineType;
            line.dataset.index = index;
            
            if (colIndex !== null) {
                line.dataset.colIndex = colIndex;
            }
            
            // æ·»åŠ æŠŠæ‰‹
            const handle = document.createElement('div');
            handle.className = 'grid-line-handle';
            if (lineType === 'row') {
                handle.textContent = 'â†•';
            } else {
                handle.textContent = 'â†”';
            }
            line.appendChild(handle);
            
            // è®¡ç®—ä½ç½®
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = elements.canvasContainer.getBoundingClientRect();
            const offsetX = canvasRect.left - containerRect.left;
            const offsetY = canvasRect.top - containerRect.top;
            
            if (type === 'horizontal') {
                const positionInCanvas = canvasRect.height * positionPercent / 100;
                const positionInContainer = offsetY + positionInCanvas;
                line.style.top = `${positionInContainer}px`;
            } else {
                const positionInCanvas = canvasRect.width * positionPercent / 100;
                const positionInContainer = offsetX + positionInCanvas;
                line.style.left = `${positionInContainer}px`;
            }
            
            // æ·»åŠ æ ‡ç­¾
            const label = document.createElement('div');
            label.className = 'line-label';
            label.textContent = `${Math.round(positionPercent)}%`;
            line.appendChild(label);
            
            // æ·»åŠ åŒå‡»äº‹ä»¶åˆ é™¤çº¿
            line.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                if (lineType === 'row' && rowsConfig.length > 1) {
                    deleteRow(index);
                } else if (lineType === 'col') {
                    const row = rowsConfig[index];
                    if (row.cols > 1) {
                        // åˆ é™¤åˆ—
                        row.cols -= 1;
                        row.colWidths.splice(colIndex, 1);
                        updateRowsConfigUI();
                        if (originalImage) {
                            createGridLines();
                            drawImageWithGrid();
                            updateSlicesPreview();
                        }
                    }
                }
            });
            
            elements.canvasContainer.appendChild(line);
            return line;
        }
        
        // ç»˜åˆ¶å›¾ç‰‡å’Œç½‘æ ¼
        function drawImageWithGrid() {
            if (!originalImage) return;
            
            // æ¸…é™¤Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å›¾ç‰‡
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶å‚è€ƒçº¿
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.3)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            // ç»˜åˆ¶æ°´å¹³å‚è€ƒçº¿
            let cumulativeHeight = 0;
            for (let i = 0; i < rowsConfig.length - 1; i++) {
                cumulativeHeight += rowsConfig[i].heightPercent;
                const y = (cumulativeHeight / 100) * canvas.height;
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶æ¯è¡Œçš„å‚ç›´å‚è€ƒçº¿
            let rowTop = 0;
            rowsConfig.forEach(row => {
                const rowHeight = (row.heightPercent / 100) * canvas.height;
                let cumulativeWidth = 0;
                
                for (let col = 0; col < row.cols - 1; col++) {
                    cumulativeWidth += row.colWidths[col];
                    const x = (cumulativeWidth / 100) * canvas.width;
                    
                    ctx.beginPath();
                    ctx.moveTo(x, rowTop);
                    ctx.lineTo(x, rowTop + rowHeight);
                    ctx.stroke();
                }
                
                rowTop += rowHeight;
            });
            
            ctx.setLineDash([]);
        }
        
        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        function handleMouseDown(e) {
            const target = e.target;
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç½‘æ ¼çº¿
            if (target.classList.contains('grid-line')) {
                isDragging = true;
                activeLine = target;
                
                // è®°å½•èµ·å§‹ä½ç½®
                dragStartPos.x = e.clientX;
                dragStartPos.y = e.clientY;
                
                // æ·»åŠ æ‹–æ‹½æ ·å¼
                target.classList.add('dragging');
                
                // é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
                e.preventDefault();
                e.stopPropagation();
                
                // æ˜¾ç¤ºçº¿æŒ‡ç¤ºå™¨
                showLineIndicator(target);
                
                return true;
            }
            
            return false;
        }
        
        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        function handleMouseMove(e) {
            if (!isDragging || !activeLine) return;
            
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = elements.canvasContainer.getBoundingClientRect();
            
            // è®¡ç®—é¼ æ ‡ç§»åŠ¨è·ç¦»
            const deltaX = e.clientX - dragStartPos.x;
            const deltaY = e.clientY - dragStartPos.y;
            
            // è·å–çº¿ç±»å‹å’Œç´¢å¼•
            const lineType = activeLine.dataset.type;
            const index = parseInt(activeLine.dataset.index);
            const colIndex = activeLine.dataset.colIndex ? parseInt(activeLine.dataset.colIndex) : null;
            
            if (lineType === 'row') {
                // æ°´å¹³çº¿ - è°ƒæ•´è¡Œé«˜
                const deltaPercent = (deltaY / canvasRect.height) * 100;
                
                // è·å–å½“å‰è¡Œçš„ä½ç½®
                let currentPosition = 0;
                for (let i = 0; i <= index; i++) {
                    currentPosition += rowsConfig[i].heightPercent;
                }
                
                // è®¡ç®—æ–°ä½ç½®
                let newPosition = currentPosition + deltaPercent;
                
                // é™åˆ¶ä½ç½®èŒƒå›´
                const minPosition = index > 0 ? 
                    rowsConfig.slice(0, index).reduce((sum, row) => sum + row.heightPercent, 0) + 5 : 5;
                const maxPosition = index < rowsConfig.length - 2 ?
                    rowsConfig.slice(0, index + 2).reduce((sum, row) => sum + row.heightPercent, 0) - 5 : 95;
                
                newPosition = Math.max(minPosition, Math.min(maxPosition, newPosition));
                
                // æ›´æ–°è¡Œé«˜
                const diff = newPosition - currentPosition;
                rowsConfig[index].heightPercent += diff;
                rowsConfig[index + 1].heightPercent -= diff;
                
                // ç¡®ä¿é«˜åº¦åˆç†
                rowsConfig[index].heightPercent = Math.max(5, Math.min(95, rowsConfig[index].heightPercent));
                rowsConfig[index + 1].heightPercent = Math.max(5, Math.min(95, rowsConfig[index + 1].heightPercent));
                
                // æ›´æ–°èµ·å§‹ä½ç½®
                dragStartPos.y = e.clientY;
                
            } else if (lineType === 'col' && colIndex !== null) {
                // å‚ç›´çº¿ - è°ƒæ•´åˆ—å®½
                const deltaPercent = (deltaX / canvasRect.width) * 100;
                
                // è·å–å½“å‰åˆ—çš„ä½ç½®
                const row = rowsConfig[index];
                let currentPosition = 0;
                for (let i = 0; i <= colIndex; i++) {
                    currentPosition += row.colWidths[i];
                }
                
                // è®¡ç®—æ–°ä½ç½®
                let newPosition = currentPosition + deltaPercent;
                
                // é™åˆ¶ä½ç½®èŒƒå›´
                const minPosition = colIndex > 0 ? 
                    row.colWidths.slice(0, colIndex).reduce((sum, width) => sum + width, 0) + 5 : 5;
                const maxPosition = colIndex < row.cols - 2 ? 
                    row.colWidths.slice(0, colIndex + 2).reduce((sum, width) => sum + width, 0) - 5 : 95;
                
                newPosition = Math.max(minPosition, Math.min(maxPosition, newPosition));
                
                // æ›´æ–°åˆ—å®½
                const diff = newPosition - currentPosition;
                updateColumnWidths(index, colIndex, newPosition);
                
                // æ›´æ–°èµ·å§‹ä½ç½®
                dragStartPos.x = e.clientX;
            }
            
            // æ›´æ–°UIå’Œé¢„è§ˆ
            updateRowsConfigUI();
            createGridLines();
            drawImageWithGrid();
            updateSlicesPreview();
            
            // æ›´æ–°çº¿æŒ‡ç¤ºå™¨
            updateLineIndicator();
            
            e.preventDefault();
        }
        
        // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
        function handleMouseUp() {
            if (isDragging && activeLine) {
                activeLine.classList.remove('dragging');
                hideLineIndicator();
            }
            
            isDragging = false;
            activeLine = null;
        }
        
        // è§¦æ‘¸å¼€å§‹äº‹ä»¶
        function handleTouchStart(e) {
            if (e.touches.length !== 1) return;
            
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (target && target.classList.contains('grid-line')) {
                // æ¨¡æ‹Ÿé¼ æ ‡äº‹ä»¶
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY,
                    bubbles: true
                });
                target.dispatchEvent(mouseEvent);
                e.preventDefault();
            }
        }
        
        // è§¦æ‘¸ç§»åŠ¨äº‹ä»¶
        function handleTouchMove(e) {
            if (e.touches.length !== 1 || !isDragging) return;
            
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY,
                bubbles: true
            });
            document.dispatchEvent(mouseEvent);
            e.preventDefault();
        }
        
        // è§¦æ‘¸ç»“æŸäº‹ä»¶
        function handleTouchEnd() {
            handleMouseUp();
        }
        
        // æ˜¾ç¤ºçº¿æŒ‡ç¤ºå™¨
        function showLineIndicator(line) {
            const rect = line.getBoundingClientRect();
            const containerRect = elements.canvasContainer.getBoundingClientRect();
            
            lineIndicator.style.left = `${rect.left - containerRect.left + rect.width/2}px`;
            lineIndicator.style.top = `${rect.top - containerRect.top + rect.height/2}px`;
            lineIndicator.classList.add('active');
        }
        
        // æ›´æ–°çº¿æŒ‡ç¤ºå™¨
        function updateLineIndicator() {
            if (!activeLine) return;
            
            const rect = activeLine.getBoundingClientRect();
            const containerRect = elements.canvasContainer.getBoundingClientRect();
            
            lineIndicator.style.left = `${rect.left - containerRect.left + rect.width/2}px`;
            lineIndicator.style.top = `${rect.top - containerRect.top + rect.height/2}px`;
        }
        
        // éšè—çº¿æŒ‡ç¤ºå™¨
        function hideLineIndicator() {
            lineIndicator.classList.remove('active');
        }
        
        // åº”ç”¨å‡åŒ€ç½‘æ ¼
        function applyUniformGrid() {
            const rows = rowsConfig.length;
            const cols = prompt(`è¯·è¾“å…¥æ¯è¡Œåˆ—æ•° (1-10):`, '3');
            
            if (!cols) return;
            
            const colCount = parseInt(cols);
            if (isNaN(colCount) || colCount < 1 || colCount > 10) {
                alert('åˆ—æ•°å¿…é¡»åœ¨1-10ä¹‹é—´');
                return;
            }
            
            // å‡åŒ€åˆ†é…
            rowsConfig.forEach(row => {
                row.cols = colCount;
                row.heightPercent = 100 / rows;
                row.colWidths = Array(colCount).fill(100 / colCount);
            });
            
            updateRowsConfigUI();
            
            if (originalImage) {
                createGridLines();
                drawImageWithGrid();
                updateSlicesPreview();
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰çº¿
        function clearAllLines() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰åˆ‡å‰²çº¿å—ï¼Ÿå›¾ç‰‡å°†ä¿ç•™å®Œæ•´çŠ¶æ€ã€‚')) {
                rowsConfig = [
                    { id: 1, cols: 1, heightPercent: 100, colWidths: [100] }
                ];
                
                updateRowsConfigUI();
                
                if (originalImage) {
                    createGridLines();
                    drawImageWithGrid();
                    updateSlicesPreview();
                }
            }
        }
        
        // æ›´æ–°åˆ‡ç‰‡é¢„è§ˆ
        function updateSlicesPreview() {
            if (!originalImage || rowsConfig.length === 0) {
                elements.slicesGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ–¼ï¸</div>
                        <p class="empty-text">è¯·ä¸Šä¼ å›¾ç‰‡å¹¶è®¾ç½®åˆ‡å‰²å¸ƒå±€</p>
                    </div>
                `;
                return;
            }
            
            const slicePositions = calculateSlicePositions();
            
            if (slicePositions.length === 0) {
                elements.slicesGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ–¼ï¸</div>
                        <p class="empty-text">è¯·è®¾ç½®åˆ‡å‰²å¸ƒå±€</p>
                    </div>
                `;
                return;
            }
            
            elements.slicesGrid.innerHTML = '';
            
            // é™åˆ¶é¢„è§ˆæ•°é‡ï¼Œé¿å…æ€§èƒ½é—®é¢˜
            const maxPreview = 30;
            const positionsToShow = slicePositions.slice(0, maxPreview);
            
            positionsToShow.forEach((pos, index) => {
                const sliceCard = document.createElement('div');
                sliceCard.className = 'slice-card';
                sliceCard.dataset.index = index;
                sliceCard.dataset.positionIndex = index;
                sliceCard.title = `åˆ‡ç‰‡ ${pos.row}-${pos.col} (${Math.round(pos.width)}Ã—${Math.round(pos.height)}åƒç´ )`;
                
                // åˆ›å»ºåˆ‡ç‰‡ç¼–å·å¾½ç« 
                const badge = document.createElement('div');
                badge.className = 'slice-badge';
                badge.textContent = `${pos.row}-${pos.col}`;
                
                // åˆ›å»ºcanvasç»˜åˆ¶åˆ‡ç‰‡
                const sliceCanvas = document.createElement('canvas');
                sliceCanvas.width = Math.min(200, pos.width);
                sliceCanvas.height = Math.min(200, pos.height);
                const sliceCtx = sliceCanvas.getContext('2d');
                
                // ç»˜åˆ¶åˆ‡ç‰‡ï¼ˆæŒ‰æ¯”ä¾‹ç¼©æ”¾ä»¥æå‡æ€§èƒ½ï¼‰
                const scale = Math.min(200 / pos.width, 200 / pos.height, 1);
                sliceCtx.drawImage(
                    originalImage,
                    pos.sx, pos.sy, pos.swidth, pos.sheight,
                    0, 0, pos.width * scale, pos.height * scale
                );
                
                // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                const img = new Image();
                img.onload = function() {
                    // æ›´æ–°å¡ç‰‡å†…å®¹
                    sliceCard.innerHTML = '';
                    sliceCard.appendChild(badge);
                    sliceCard.appendChild(img);
                    
                    // å¦‚æœæ˜¯é€‰ä¸­çš„åˆ‡ç‰‡ï¼Œæ·»åŠ é€‰ä¸­æ ·å¼
                    if (selectedSlice && selectedSlice.row === pos.row && selectedSlice.col === pos.col) {
                        sliceCard.classList.add('selected');
                    }
                };
                img.src = sliceCanvas.toDataURL('image/png');
                img.alt = `åˆ‡ç‰‡ ${pos.row}-${pos.col}`;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶é€‰æ‹©åˆ‡ç‰‡
                sliceCard.addEventListener('click', () => {
                    selectSlice(pos, sliceCard);
                });
                
                elements.slicesGrid.appendChild(sliceCard);
            });
            
            // å¦‚æœåˆ‡ç‰‡æ•°é‡è¶…è¿‡é¢„è§ˆé™åˆ¶ï¼Œæ˜¾ç¤ºæç¤º
            if (slicePositions.length > maxPreview) {
                const warning = document.createElement('div');
                warning.style.gridColumn = '1 / -1';
                warning.style.textAlign = 'center';
                warning.style.padding = '10px';
                warning.style.color = '#64748b';
                warning.style.fontSize = '0.9rem';
                warning.innerHTML = `å…± ${slicePositions.length} ä¸ªåˆ‡ç‰‡ï¼Œæ˜¾ç¤ºå‰ ${maxPreview} ä¸ªé¢„è§ˆ`;
                elements.slicesGrid.appendChild(warning);
            }
        }
        
        // é€‰æ‹©åˆ‡ç‰‡
        function selectSlice(slice, sliceCard) {
            // ç§»é™¤ä¹‹å‰é€‰ä¸­çš„æ ·å¼
            document.querySelectorAll('.slice-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            
            // æ·»åŠ å½“å‰é€‰ä¸­æ ·å¼
            sliceCard.classList.add('selected');
            selectedSlice = slice;
            
            // æ›´æ–°é€‰ä¸­åˆ‡ç‰‡ä¿¡æ¯é¢æ¿
            updateSelectedSliceInfo(slice);
        }
        
        // æ›´æ–°é€‰ä¸­åˆ‡ç‰‡ä¿¡æ¯ - ä¿®å¤ï¼šä½¿ç”¨btn-renameç±»
        function updateSelectedSliceInfo(slice) {
            elements.selectedSliceInfo.innerHTML = `
                <div class="selected-slice-info">
                    <h4>ğŸ¯ é€‰ä¸­åˆ‡ç‰‡ ${slice.row}-${slice.col}</h4>
                    <div class="slice-details">
                        <div class="slice-detail-item">
                            <span class="slice-detail-label">å°ºå¯¸</span>
                            <span class="slice-detail-value">${Math.round(slice.width)}Ã—${Math.round(slice.height)}åƒç´ </span>
                        </div>
                        <div class="slice-detail-item">
                            <span class="slice-detail-label">ä½ç½®</span>
                            <span class="slice-detail-value">X:${Math.round(slice.sx)} Y:${Math.round(slice.sy)}</span>
                        </div>
                    </div>
                    <div class="dual-buttons">
                        <button class="btn btn-secondary" id="downloadSelectedSliceBtn">
                            <span class="btn-icon">â¬‡ï¸</span> ä¸‹è½½æ­¤åˆ‡ç‰‡
                        </button>
                        <button class="btn btn-rename" id="renameSelectedSliceBtn">
                            <span class="btn-icon">âœï¸</span> é‡å‘½åä¸‹è½½
                        </button>
                    </div>
                </div>
            `;
            
            // ä¸ºä¸‹è½½æ­¤åˆ‡ç‰‡æŒ‰é’®æ·»åŠ äº‹ä»¶
            document.getElementById('downloadSelectedSliceBtn').addEventListener('click', () => {
                downloadSelectedSlice();
            });
            
            // ä¸ºé‡å‘½åæŒ‰é’®æ·»åŠ äº‹ä»¶
            document.getElementById('renameSelectedSliceBtn').addEventListener('click', () => {
                openRenameModal(slice);
            });
        }
        
        // è®¡ç®—åˆ‡ç‰‡ä½ç½®
        function calculateSlicePositions() {
            if (!originalImage || rowsConfig.length === 0) return [];
            
            const positions = [];
            
            // è®¡ç®—æ¯è¡Œçš„ç´¯è®¡é«˜åº¦
            let cumulativeHeightPercent = 0;
            
            for (let rowIndex = 0; rowIndex < rowsConfig.length; rowIndex++) {
                const row = rowsConfig[rowIndex];
                
                // è®¡ç®—è¯¥è¡Œçš„é¡¶éƒ¨å’Œåº•éƒ¨ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰
                const rowTopPercent = cumulativeHeightPercent;
                const rowBottomPercent = cumulativeHeightPercent + row.heightPercent;
                
                // è®¡ç®—è¯¥è¡Œçš„é¡¶éƒ¨å’Œåº•éƒ¨ä½ç½®ï¼ˆåƒç´ ï¼‰
                const rowTopPx = originalImage.height * rowTopPercent / 100;
                const rowBottomPx = originalImage.height * rowBottomPercent / 100;
                const rowHeightPx = rowBottomPx - rowTopPx;
                
                // å°†è¯¥è¡Œçš„åˆ—çº¿è½¬æ¢ä¸ºåƒç´ ä½ç½®
                const colLinesPx = [0];
                let cumulativeWidth = 0;
                for (let i = 0; i < row.cols - 1; i++) {
                    cumulativeWidth += row.colWidths[i];
                    colLinesPx.push(originalImage.width * cumulativeWidth / 100);
                }
                colLinesPx.push(originalImage.width);
                
                // ç”Ÿæˆè¯¥è¡Œçš„æ‰€æœ‰åˆ‡ç‰‡
                for (let colIndex = 0; colIndex < row.cols; colIndex++) {
                    positions.push({
                        sx: colLinesPx[colIndex], // æºXåæ ‡
                        sy: rowTopPx, // æºYåæ ‡
                        swidth: colLinesPx[colIndex + 1] - colLinesPx[colIndex], // æºå®½åº¦
                        sheight: rowHeightPx, // æºé«˜åº¦
                        width: colLinesPx[colIndex + 1] - colLinesPx[colIndex], // åˆ‡ç‰‡å®½åº¦
                        height: rowHeightPx, // åˆ‡ç‰‡é«˜åº¦
                        row: rowIndex + 1,
                        col: colIndex + 1
                    });
                }
                
                cumulativeHeightPercent += row.heightPercent;
            }
            
            return positions;
        }
        
        // ä¸‹è½½æ‰€æœ‰åˆ‡ç‰‡
        async function downloadAllSlices() {
            if (!originalImage) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }
            
            if (rowsConfig.length === 0) {
                alert('è¯·è®¾ç½®åˆ‡å‰²å¸ƒå±€ï¼');
                return;
            }
            
            elements.loading.style.display = 'flex';
            
            try {
                const zip = new JSZip();
                const folder = zip.folder('å›¾ç‰‡åˆ‡ç‰‡');
                
                const slicePositions = calculateSlicePositions();
                
                for (let i = 0; i < slicePositions.length; i++) {
                    const slice = slicePositions[i];
                    const canvas = document.createElement('canvas');
                    canvas.width = slice.width;
                    canvas.height = slice.height;
                    const ctx = canvas.getContext('2d');
                    
                    ctx.drawImage(
                        originalImage,
                        slice.sx, slice.sy, slice.swidth, slice.sheight,
                        0, 0, slice.width, slice.height
                    );
                    
                    const blob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/png', 0.95);
                    });
                    
                    folder.file(`åˆ‡ç‰‡_${slice.row}_${slice.col}.png`, blob);
                }
                
                const content = await zip.generateAsync({ type: 'blob' });
                const rowInfo = rowsConfig.map(row => row.cols).join('-');
                const fileName = `å›¾ç‰‡åˆ‡ç‰‡_${rowsConfig.length}è¡Œ(${rowInfo}åˆ—)_${new Date().getTime()}.zip`;
                
                saveAs(content, fileName);
                
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            } finally {
                elements.loading.style.display = 'none';
            }
        }
        
        // ä¸‹è½½é€‰ä¸­åˆ‡ç‰‡
        function downloadSelectedSlice() {
            if (!selectedSlice) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ‡ç‰‡ï¼');
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = selectedSlice.width;
            canvas.height = selectedSlice.height;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(
                originalImage,
                selectedSlice.sx, selectedSlice.sy, selectedSlice.swidth, selectedSlice.sheight,
                0, 0, selectedSlice.width, selectedSlice.height
            );
            
            canvas.toBlob(blob => {
                const fileName = `åˆ‡ç‰‡_${selectedSlice.row}_${selectedSlice.col}.png`;
                saveAs(blob, fileName);
            }, 'image/png', 0.95);
        }
        
        // é‡ç½®æ‰€æœ‰è®¾ç½®
        function resetAll() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿå›¾ç‰‡å°†ä¿ç•™ï¼Œä½†æ‰€æœ‰åˆ‡å‰²çº¿å°†è¢«æ¸…é™¤ã€‚')) {
                initializeDefaultConfig();
                
                // æ¸…é™¤é¢„è®¾æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                
                // æ¸…é™¤é€‰ä¸­çš„åˆ‡ç‰‡
                selectedSlice = null;
                elements.selectedSlicePanel.style.display = 'block';
                elements.selectedSliceInfo.innerHTML = `
                    <div class="empty-state" style="padding: 10px 0;">
                        <div class="empty-icon">ğŸ¯</div>
                        <p class="empty-text">ç‚¹å‡»å·¦ä¾§åˆ‡ç‰‡é¢„è§ˆä¸­çš„åˆ‡ç‰‡è¿›è¡Œé€‰æ‹©</p>
                    </div>
                `;
                
                updateRowsConfigUI();
                
                if (originalImage) {
                    createGridLines();
                    drawImageWithGrid();
                    updateSlicesPreview();
                }
            }
        }
        
        // é”®ç›˜å¿«æ·é”®
        function handleKeyboard(e) {
            // Escé”®å–æ¶ˆæ‹–æ‹½
            if (e.key === 'Escape' && isDragging) {
                handleMouseUp();
            }
            
            // åˆ é™¤é”® - åˆ é™¤é€‰ä¸­çš„ç½‘æ ¼çº¿
            if (e.key === 'Delete' && activeLine) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ é™¤ç½‘æ ¼çº¿çš„é€»è¾‘
            }
        }
    </script>
</body>
</html>